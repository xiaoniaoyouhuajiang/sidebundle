name: bwrap-smoke

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smoke tests in privileged container
        uses: addnab/docker-run-action@v3
        with:
          image: ubuntu:22.04
          options: --privileged --security-opt seccomp=unconfined
          run: |
            set -euo pipefail
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
              bubblewrap sudo curl build-essential \
              nodejs python3 openjdk-17-jdk \
              ca-certificates git pkg-config libssl-dev
            # Install Rust via rustup
            curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
            export PATH="$HOME/.cargo/bin:$PATH"
            cd /github/workspace
            cargo build --release -p sidebundle-cli
            scripts/bwrap_smoke.sh
